# Unir nodos adicionales al clúster

## Nodo Worker

https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/

Los tokens generador caducan al cabo de 24h. Puedes obtener una lista de *tokens* desde el nodo *master* mediante:

```bash
kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION
                              EXTRA GROUPS
057l8q.y8ybcouzoql7c30l   6h          2020-05-31T23:50:03+02:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```

De la [documentación del comando `kubeadm join`](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/) vemos que podemos obtener el comando para unir un nodo *worker* al clúster mediante: `kubeadm token create --print-join-command`. Ejecutamos el comando en el nodo *master*:

```bash
$ kubeadm token create --print-join-command
W0531 17:33:07.084765   21687 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
kubeadm join cluster-endpoint:6443 --token agous7.g2lhmr0ccj9slbpo     --discovery-token-ca-cert-hash sha256:540a59b4a70db7478d0019822168551df660ec7f0da2fd8f424bba64816bf92e
```

En el nodo *worker* a unir al clúster (desde donde debe poder resolverse la IP asociada a `cluster-endpoint`):

```bash
$ sudo kubeadm join cluster-endpoint:6443 --token agous7.g2lhmr0ccj9slbpo     --discovery-token-ca-cert-hash sha256:540a59b4a70db7478d0019822168551df660ec7f0da2fd8f424bba64816bf92e
sudo kubeadm join cluster-endpoint:6443 --token agous7.g2lhmr0ccj9slbpo     --discovery-token-ca-cert-hash sha256:540a59b4a70db7478d0019822168551df660ec7f0da2fd8f424bba64816bf92e
[sudo] password for operador:
W0531 17:34:55.587231     832 join.go:346] [preflight] WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set.
[preflight] Running pre-flight checks
        [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.18" ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```

En el nodo *master* ejecutamos `watch kubectl get nodes` hasta que el nuevo nodo *worker* aparece como *Ready*:

```bash
$ kubectl get nodes
NAME         STATUS   ROLES    AGE     VERSION
k-master-0   Ready    master   17h     v1.18.3
k-worker-1   Ready    <none>   17h     v1.18.3
k-worker-2   Ready    <none>   17h     v1.18.3
k-worker-3   Ready    <none>   5m15s   v1.18.3
```
